pipeline {
    agent any

    environment {
        // Gitä»“åº“é…ç½®
        GIT_REPO = 'https://github.com/Skysolderone/ws_mcp.git'
        GIT_BRANCH = 'master'

        // Dockeré•œåƒé…ç½®
        DOCKER_REGISTRY = 'harbor.wws741.top'
        IMAGE_NAME = 'mcp/mcp-server'
        IMAGE_TAG = "${BUILD_NUMBER}"

        // ç”Ÿäº§æœåŠ¡å™¨é…ç½®
        PROD_SERVER = 'ec2-54-65-152-26.ap-northeast-1.compute.amazonaws.com'
        PROD_USER = 'ec2-user'

        // Harborå‡­è¯ï¼ˆç”¨æˆ·åå’Œå¯†ç ï¼Œåœ¨Jenkinsä¸­é…ç½®ï¼‰
        HARBOR_USERNAME = 'admin'
        HARBOR_PASSWORD = 'gg123456'  // å»ºè®®ç”¨Jenkinså‡­è¯è€Œéæ˜æ–‡
    }

    stages {
        stage('æ£€å‡ºä»£ç ') {
            steps {
                echo "æ‹‰å–æœ€æ–°ä»£ç : ${GIT_REPO} åˆ†æ”¯: ${GIT_BRANCH}"
                git branch: "${GIT_BRANCH}", url: "${GIT_REPO}"
            }
        }

        stage('æ„å»ºDockeré•œåƒ') {
            steps {
                script {
                    echo "æ„å»ºDockeré•œåƒ: ${IMAGE_NAME}:${IMAGE_TAG}"
                    sh """

                        docker build -t ${DOCKER_REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG} .
                        docker tag ${DOCKER_REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG} ${DOCKER_REGISTRY}/${IMAGE_NAME}:latest
                    """
                }
            }
        }

        stage('æ¨é€é•œåƒ') {
            steps {
                script {
                    echo 'ç™»å½•Harborå¹¶æ¨é€é•œåƒ...'
                    sh """
                        echo ${HARBOR_PASSWORD} | docker login ${DOCKER_REGISTRY} -u ${HARBOR_USERNAME} --password-stdin
                        docker push ${DOCKER_REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG}
                        docker push ${DOCKER_REGISTRY}/${IMAGE_NAME}:latest
                        docker logout ${DOCKER_REGISTRY}
                    """
                }
            }
        }

        stage('éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ') {
            steps {
                script {
                    echo "éƒ¨ç½²åˆ°ç”Ÿäº§æœåŠ¡å™¨: ${PROD_SERVER}"

                    // ä½¿ç”¨sshagentç®¡ç†SSHå‡­æ®
                    sshagent(['prod-ec2-ssh-key']) {
                        sh """
                            ssh -o StrictHostKeyChecking=no ${PROD_USER}@${PROD_SERVER} '
                                # ç™»å½•Harbor
                                echo ${HARBOR_PASSWORD} | docker login ${DOCKER_REGISTRY} -u ${HARBOR_USERNAME} --password-stdin

                                # æ‹‰å–æœ€æ–°é•œåƒ
                                docker pull ${DOCKER_REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG}

                                # åœæ­¢å¹¶åˆ é™¤æ—§å®¹å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                                docker stop eino-use || true
                                docker rm eino-use || true

                                # å¯åŠ¨æ–°å®¹å™¨
                                # æ³¨æ„ï¼šeino_use æ˜¯å‘½ä»¤è¡Œå·¥å…·ï¼Œå¦‚æœéœ€è¦æŒç»­è¿è¡Œï¼Œå¯ä»¥ä½¿ç”¨ docker run -d
                                # å¦‚æœéœ€è¦äº¤äº’å¼è¿è¡Œï¼Œå¯ä»¥å»æ‰ -d å‚æ•°
                                docker run -d \\
                                    --name eino-use \\
                                    --restart=always \\
                                    -e TZ=Asia/Shanghai \\
                                    -e CLAUDE_API_KEY=\${CLAUDE_API_KEY:-} \\
                                    -e BINANCE_API_KEY=\${BINANCE_API_KEY:-} \\
                                    -e BINANCE_SECRET_KEY=\${BINANCE_SECRET_KEY:-} \\
                                    -e TRADE_RPC_URL=\${TRADE_RPC_URL:-} \\
                                    -v /app/eino-use/config:/app/config \\
                                    ${DOCKER_REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG}

                                # æ¸…ç†æ—§é•œåƒ
                                docker image prune -af --filter "label!=keep"

                                # é€€å‡ºç™»å½•
                                docker logout ${DOCKER_REGISTRY}
                            '
                        """
                    }
                }
            }
        }

        stage('å¥åº·æ£€æŸ¥') {
            steps {
                script {
                    echo 'ç­‰å¾…æœåŠ¡å¯åŠ¨...'
                    sleep 10

                    sshagent(['prod-ec2-ssh-key']) {
                        sh """
                            ssh -o StrictHostKeyChecking=no ${PROD_USER}@${PROD_SERVER} '
                                # æ£€æŸ¥å®¹å™¨çŠ¶æ€
                                docker ps | grep eino-use || echo "å®¹å™¨æœªè¿è¡Œ"

                                # æ£€æŸ¥å®¹å™¨æ—¥å¿—ï¼ˆæœ€è¿‘10è¡Œï¼‰
                                docker logs --tail 10 eino-use || echo "æ— æ³•è·å–å®¹å™¨æ—¥å¿—"
                            '
                        """
                    }
                    echo 'âœ“ éƒ¨ç½²å®Œæˆ'
                }
            }
        }
    }

    post {
        success {
            echo 'ğŸ‰ éƒ¨ç½²æˆåŠŸï¼'
            // å¯ä»¥æ·»åŠ é€šçŸ¥ï¼Œå¦‚é’‰é’‰ã€ä¼ä¸šå¾®ä¿¡ç­‰
        }
        failure {
            echo 'âŒ éƒ¨ç½²å¤±è´¥ï¼'
            // å¯ä»¥æ·»åŠ å‘Šè­¦é€šçŸ¥
        }
        always {
            script {
                // æ¸…ç†æœ¬åœ°Dockeré•œåƒ
                sh "docker rmi ${env.DOCKER_REGISTRY}/${env.IMAGE_NAME}:${env.IMAGE_TAG} || true"
            }
        }
    }
}
